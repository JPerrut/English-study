<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>English Pro - Aprenda com Histórias</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #f59e0b;
      --secondary-dark: #d97706;
      --dark: #1e293b;
      --darker: #0f172a;
      --light: #f8fafc;
      --gray: #64748b;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--darker), #1e1b4b);
      color: var(--light);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }
    .container {
      width: 100%;
      max-width: 800px;
      background-color: rgba(30, 41, 59, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      padding: 24px;
      text-align: center;
      position: relative;
    }
    .header h1 {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .header p {
      font-size: 16px;
      opacity: 0.9;
    }
    .content {
      padding: 32px;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }
    .btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .btn:hover::after {
      left: 100%;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
    }
    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
      color: var(--darker);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
    }
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    .btn-outline:hover {
      background: var(--primary);
      color: white;
    }
    .btn-small {
      padding: 12px 20px;
      font-size: 16px;
      width: auto;
      display: inline-block;
      margin-right: 12px;
    }
    .chapters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }
    .chapter-card {
      background: rgba(30, 41, 59, 0.7);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .chapter-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      border-color: var(--primary);
    }
    .chapter-number {
      font-size: 14px;
      color: var(--gray);
      margin-bottom: 8px;
    }
    .chapter-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .chapter-stats {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--gray);
    }
    .question-container {
      background: rgba(30, 41, 59, 0.7);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .question-number {
      font-size: 14px;
      color: var(--gray);
    }
    .progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 0.5s ease;
    }
    .question-text {
      font-size: 20px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 24px;
      line-height: 1.5;
      padding: 16px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
    }
    .input-container {
      margin-bottom: 24px;
    }
    .answer-input {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.5);
      color: white;
      font-size: 18px;
      transition: all 0.3s ease;
    }
    .answer-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    .feedback-container {
      background: rgba(15, 23, 42, 0.7);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border-left: 4px solid var(--primary);
    }
    .feedback-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .correct-answer {
      font-size: 18px;
      font-weight: 600;
      color: var(--success);
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 8px;
    }
    .vocab-section {
      margin-top: 20px;
    }
    .vocab-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--secondary);
    }
    .vocab-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .vocab-table th, .vocab-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .vocab-table th {
      color: var(--gray);
      font-weight: 500;
    }
    .word-feedback {
      margin: 16px 0;
      padding: 16px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 8px;
    }
    .word-feedback-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--secondary);
    }
    .word-feedback-content {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .word-bubble {
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
    }
    .word-correct {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid var(--success);
    }
    .word-wrong-position {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
    }
    .word-incorrect {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
      border: 1px solid var(--error);
    }
    .word-missing {
      background: rgba(100, 116, 139, 0.2);
      color: var(--gray);
      border: 1px solid var(--gray);
      text-decoration: line-through;
    }
    .retry-container {
      text-align: center;
      margin-top: 20px;
      padding: 16px;
      background: rgba(245, 158, 11, 0.1);
      border-radius: 8px;
      border-left: 4px solid var(--warning);
    }
    .retry-message {
      font-size: 16px;
      margin-bottom: 12px;
      color: var(--warning);
    }
    .hidden {
      display: none !important;
    }
    .text-center {
      text-align: center;
    }
    .mt-4 {
      margin-top: 24px;
    }
    .mb-4 {
      margin-bottom: 24px;
    }
    .icon {
      margin-right: 8px;
    }
    .score-display {
      text-align: center;
      padding: 32px;
    }
    .score-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: conic-gradient(var(--primary) 0%, var(--dark) 0%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      position: relative;
    }
    .score-circle::before {
      content: '';
      position: absolute;
      width: 100px;
      height: 100px;
      background: var(--darker);
      border-radius: 50%;
    }
    .score-value {
      position: relative;
      z-index: 1;
      font-size: 28px;
      font-weight: 700;
    }
    .completion-message {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 16px;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      margin: 24px 0;
    }
    .stat {
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }
    .stat-label {
      font-size: 14px;
      color: var(--gray);
    }
    @media (max-width: 600px) {
      .content {
        padding: 20px;
      }
      .header h1 {
        font-size: 24px;
      }
      .question-text {
        font-size: 18px;
      }
      .btn {
        padding: 14px 20px;
        font-size: 16px;
      }
      .chapters-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Menu Principal -->
    <div id="main-menu">
      <div class="header">
        <h1><i class="fas fa-language icon"></i>English Pro</h1>
        <p>Aprenda inglês com suas histórias favoritas</p>
      </div>
      <div class="content">
        <button id="story-mode-btn" class="btn btn-primary">
          <i class="fas fa-book-open icon"></i>Inglês com História
        </button>
      </div>
    </div>
    <!-- Seleção de Capítulo -->
    <div id="chapters-menu" class="hidden">
      <div class="header">
        <button id="back-to-main" class="btn btn-outline btn-small">
          <i class="fas fa-arrow-left icon"></i>Voltar
        </button>
        <h1><i class="fas fa-book icon"></i>Capítulos</h1>
        <p>Selecione um capítulo para praticar</p>
      </div>
      <div class="content">
        <div class="chapters-grid" id="chapters-grid">
          <!-- Capítulos serão gerados dinamicamente -->
        </div>
      </div>
    </div>
    <!-- Seleção de Nível -->
    <div id="level-menu" class="hidden">
      <div class="header">
        <button id="back-to-chapters" class="btn btn-outline btn-small">
          <i class="fas fa-arrow-left icon"></i>Voltar
        </button>
        <h1 id="chapter-level-title">Capítulo </h1>
        <p>Escolha um nível para praticar</p>
      </div>
      <div class="content" id="levels-grid">
        <!-- Níveis serão gerados dinamicamente -->
      </div>
    </div>
    <!-- Seleção de Modo de Prática -->
    <div id="practice-mode-menu" class="hidden">
      <div class="header">
        <button id="back-to-levels" class="btn btn-outline btn-small">
          <i class="fas fa-arrow-left icon"></i>Voltar
        </button>
        <h1 id="chapter-practice-title">Nível </h1>
        <p>Selecione o modo de prática</p>
      </div>
      <div class="content">
        <button id="easy-practice-btn" class="btn btn-primary">
          <i class="fas fa-star icon"></i>Prática Fácil
          <br><small>Traduza do Inglês para Português</small>
        </button>
        <button id="hard-practice-btn" class="btn btn-secondary">
          <i class="fas fa-fire icon"></i>Prática Difícil
          <br><small>Traduza do Português para Inglês</small>
        </button>
      </div>
    </div>
    <!-- Tela de Questões -->
    <div id="quiz-screen" class="hidden">
      <div class="header">
        <button id="back-to-practice" class="btn btn-outline btn-small">
          <i class="fas fa-arrow-left icon"></i>Voltar
        </button>
        <h1 id="quiz-title">Prática</h1>
        <p id="quiz-subtitle">Traduza a frase abaixo</p>
      </div>
      <div class="content">
        <div class="question-container">
          <div class="question-header">
            <div class="question-number" id="question-number">Questão 1 de 5</div>
            <div class="question-stats" id="question-stats">Acertos: 0 | Erros: 0</div>
          </div>
          <div class="progress-bar">
            <div class="progress" id="progress-bar" style="width: 0%"></div>
          </div>
          <div class="question-text" id="question-text"></div>
          <div class="input-container">
            <input type="text" class="answer-input" id="answer-input" placeholder="Digite sua tradução aqui...">
          </div>
          <button id="submit-answer" class="btn btn-primary">Verificar Resposta</button>
          <button id="skip-button" class="btn btn-outline mt-4">Pular Frase</button>
        </div>
        <div id="feedback-area" class="feedback-container hidden">
          <div class="feedback-title">
            <i class="fas fa-info-circle" id="feedback-icon"></i>
            <span id="feedback-title-text">Feedback</span>
          </div>
          <div class="correct-answer" id="correct-answer"></div>
          <div id="word-feedback-area" class="word-feedback hidden">
            <div class="word-feedback-title">
              <i class="fas fa-spell-check icon"></i>Análise das Palavras:
            </div>
            <div class="word-feedback-content" id="word-feedback-content">
              <!-- Conteúdo gerado dinamicamente -->
            </div>
          </div>
          <div id="retry-container" class="retry-container hidden">
            <div class="retry-message">
              <i class="fas fa-redo-alt icon"></i>Tente novamente corrigindo as palavras destacadas
            </div>
            <button id="retry-button" class="btn btn-primary btn-small">Tentar Novamente</button>
          </div>
          <div class="vocab-section">
            <div class="vocab-title">
              <i class="fas fa-book icon"></i>Tradução das Palavras
            </div>
            <table class="vocab-table" id="vocab-table">
              <!-- Conteúdo gerado dinamicamente -->
            </table>
          </div>
          <button id="next-question" class="btn btn-primary mt-4">Próxima Questão</button>
        </div>
      </div>
    </div>
    <!-- Tela de Resultados -->
    <div id="results-screen" class="hidden">
      <div class="header">
        <h1><i class="fas fa-trophy icon"></i>Resultados</h1>
        <p id="results-subtitle">Desempenho no capítulo</p>
      </div>
      <div class="content">
        <div class="score-display">
          <div class="score-circle" id="score-circle">
            <div class="score-value" id="score-value">0%</div>
          </div>
          <div class="completion-message" id="completion-message">Parabéns!</div>
          <div class="stats">
            <div class="stat">
              <div class="stat-value" id="correct-answers">0</div>
              <div class="stat-label">Acertos</div>
            </div>
            <div class="stat">
              <div class="stat-value" id="wrong-answers">0</div>
              <div class="stat-label">Erros</div>
            </div>
            <div class="stat">
              <div class="stat-value" id="completion-rate">0%</div>
              <div class="stat-label">Concluído</div>
            </div>
          </div>
          <button id="restart-practice" class="btn btn-primary">Refazer Prática</button>
          <button id="back-to-chapters-from-results" class="btn btn-outline mt-4">Voltar aos Capítulos</button>
        </div>
      </div>
    </div>
  </div>
<script>
    // Dados organizados por capítulo e nível

const CHAPTERS = [
  {
    id: 1,
    title: "Chapter 001",
    description: "Encontros no Trem",
    levels: [
      {
        id: 1,
        name: "Nível 1",
        description: "Encontros casuais e observações",
        estimatedTime: "~1 minuto",
        phrases: [
          { 
            english: "That Girl Again.", 
            portuguese: "Aquela Garota de Novo.", 
            alternativeTranslations: [
              "Aquela garota outra vez.",
              "Aquela menina de novo.",
              "Ela novamente."
            ] 
          },
          { 
            english: "I've run into her here several times already.", 
            portuguese: "Eu já cruzei com ela aqui várias vezes.", 
            alternativeTranslations: [
              "Já encontrei ela aqui várias vezes.",
              "Eu já me deparei com ela aqui várias vezes.",
              "Já cruzei com ela aqui inúmeras vezes."
            ] 
          },
          { 
            english: "She's going late again today.", 
            portuguese: "Ela está indo tarde de novo hoje.", 
            alternativeTranslations: [
              "Ela está saindo tarde outra vez hoje.",
              "Hoje ela está atrasada de novo.",
              "Ela está chegando tarde novamente hoje."
            ] 
          },
          { 
            english: "That person and I today too.", 
            portuguese: "Aquela pessoa e eu hoje também.", 
            alternativeTranslations: [
              "Eu e aquela pessoa hoje também.",
              "Aquela pessoa e eu, hoje de novo.",
              "Eu e ela hoje também."
            ] 
          },
          { 
            english: "We will take the same last train.", 
            portuguese: "Nós vamos pegar o mesmo último trem.", 
            alternativeTranslations: [
              "Vamos pegar o mesmo último trem.",
              "Pegaremos o mesmo último trem.",
              "Iremos no mesmo último trem."
            ] 
          }
        ]
      },
      {
        id: 2,
        name: "Nível 2",
        description: "Pensamentos e curiosidades",
        estimatedTime: "~1 minuto",
        phrases: [
          { 
            english: "Looking at the instrument she carries, I wonder if she's a music major?", 
            portuguese: "Olhando para o instrumento que ela carrega, eu me pergunto se ela é estudante de música?", 
            alternativeTranslations: [
              "Vendo o instrumento que ela carrega, me pergunto se estuda música?",
              "Ao olhar o instrumento que ela traz, penso se é estudante de música?",
              "Observando o instrumento dela, questiono se faz faculdade de música?"
            ] 
          },
          { 
            english: "Or maybe she's in a band?", 
            portuguese: "Ou talvez ela esteja em uma banda?", 
            alternativeTranslations: [
              "Ou será que toca numa banda?",
              "Ou talvez participe de um grupo musical?",
              "Ou quem sabe faz parte de uma banda?"
            ] 
          },
          { 
            english: "Ah! We made eye contact!", 
            portuguese: "Ah! Nós fizemos contato visual!", 
            alternativeTranslations: [
              "Ah! Nossos olhos se encontraram!",
              "Ah! Ela me olhou!",
              "Ah! Nossos olhares se cruzaram!"
            ] 
          },
          { 
            english: "I was lost in thought and stared... like a pervert...!!", 
            portuguese: "Eu estava perdido em pensamentos e encarei... como um pervertido...!!", 
            alternativeTranslations: [
              "Estava distraído e fiquei encarando... que nem um pervertido...!!",
              "Viajei nos pensamentos e fiquei olhando... igual um tarado...!!",
              "Me perdi nos pensamentos e fiquei encarando... feito um pervertido...!!"
            ] 
          },
          { 
            english: "Even though we run into each other here often...", 
            portuguese: "Embora a gente se encontre aqui frequentemente...", 
            alternativeTranslations: [
              "Apesar de nos encontrarmos aqui com frequência...",
              "Mesmo nos cruzando aqui sempre...",
              "Embora nos vejamos aqui muitas vezes..."
            ] 
          }
        ]
      },
      {
        id: 3,
        name: "Nível 3",
        description: "Reflexões e coincidências",
        estimatedTime: "~1 minuto",
        phrases: [
          { 
            english: "I guess it's only me who's aware of it.", 
            portuguese: "Eu acho que sou só eu que estou ciente disso.", 
            alternativeTranslations: [
              "Acho que só eu percebi isso.",
              "Creio que só eu notei isso.",
              "Parece que só eu estou ciente disso."
            ] 
          },
          { 
            english: "Things like this are just coincidences, not fate.", 
            portuguese: "Coisas como essa são apenas coincidências, não destino.", 
            alternativeTranslations: [
              "Essas coisas são só coincidências, não destino.",
              "Situações assim são meras coincidências, não sina do destino.",
              "Coisas desse tipo são acasos, não predestinação."
            ] 
          },
          { 
            english: "Ah... I can't concentrate on reading either.", 
            portuguese: "Ah... Eu não consigo me concentrar na leitura também.", 
            alternativeTranslations: [
              "Ah... Também não consigo focar na leitura.",
              "Ah... Nem pra ler eu consigo me concentrar.",
              "Ah... Não dá pra me concentrar na leitura também."
            ] 
          },
          { 
            english: "Let's Listen to music.", 
            portuguese: "Vamos ouvir música.", 
            alternativeTranslations: [
              "Bora ouvir música.",
              "Vamos escutar um som.",
              "Que tal ouvir música?"
            ] 
          },
          { 
            english: "Should I listen to this song again today?", 
            portuguese: "Devo ouvir esta música de novo hoje?", 
            alternativeTranslations: [
              "Será que ouço essa música outra vez hoje?",
              "Será que devo escutar essa música novamente hoje?",
              "Será que ponho essa música de novo hoje?"
            ] 
          }
        ]
      }
    ]
  },
  {
    id: 2,
    title: "Chapter 002",
    description: "A Música e os Fones",
    levels: [
      {
        id: 1,
        name: "Nível 1",
        description: "Apreciação musical e problemas técnicos",
        estimatedTime: "~1 minuto",
        phrases: [
          { 
            english: "The intro of this song is the best, no matter how many times I've heard it!", 
            portuguese: "A introdução desta música é a melhor, não importa quantas vezes eu a tenha ouvido!", 
            alternativeTranslations: [
              "A intro dessa música é incrível, por mais que eu já tenha ouvido!",
              "O começo dessa música é o máximo, não importa quantas vezes escutei!",
              "A abertura dessa música é fantástica, por mais repetições que eu faça!"
            ] 
          },
          { 
            english: "The first verse is so good too!", 
            portuguese: "O primeiro verso é tão bom também!", 
            alternativeTranslations: [
              "A primeira parte é muito boa também!",
              "O começo da letra é ótimo também!",
              "A primeira estrofe é muito boa também!"
            ] 
          },
          { 
            english: "It's such a great song...", 
            portuguese: "É uma música tão ótima...", 
            alternativeTranslations: [
              "É uma canção tão boa...",
              "Que música fantástica...",
              "É uma trilha tão incrível..."
            ] 
          },
          { 
            english: "But hardly anyone knows it...", 
            portuguese: "Mas quase ninguém a conhece...", 
            alternativeTranslations: [
              "Mas praticamente ninguém conhece...",
              "Porém quase ninguém sabe dela...",
              "Mas é desconhecida por quase todos..."
            ] 
          },
          { 
            english: "I wish there were someone to talk to about this song...", 
            portuguese: "Eu queria que houvesse alguém para conversar sobre esta música...", 
            alternativeTranslations: [
              "Queria ter alguém pra conversar sobre essa música...",
              "Desejava que existisse alguém para falar sobre essa canção...",
              "Quem me dera ter com quem conversar sobre essa música..."
            ] 
          }
        ]
      },
      {
        id: 2,
        name: "Nível 2",
        description: "Problemas técnicos e constrangimentos",
        estimatedTime: "~1 minuto",
        phrases: [
          { 
            english: "and about the long afternoon too...", 
            portuguese: "e sobre a longa tarde, também...", 
            alternativeTranslations: [
              "e também sobre a tarde longa...",
              "e sobre a longa tarde também...",
              "e acerca da longa tarde, igualmente..."
            ] 
          },
          { 
            english: "huh? But why does it sound muffled today?", 
            portuguese: "Hã? Mas por que está abafado hoje?", 
            alternativeTranslations: [
              "Hã? Mas por que está embolado hoje?",
              "Hein? Mas por que está abafado hoje?",
              "O quê? Mas por que está surdo hoje?"
            ] 
          },
          { 
            english: "Did the cheap earphones break already?", 
            portuguese: "Os fones de ouvido baratos já quebraram?", 
            alternativeTranslations: [
              "Os fones baratos já pifaram?",
              "Os fones de ouvido econômicos já estragaram?",
              "Os fones vagabundos já quebraram?"
            ] 
          },
          { 
            english: "Should I turn up the volume a little more...", 
            portuguese: "Devo aumentar o volume um pouco mais...", 
            alternativeTranslations: [
              "Será que aumento o volume mais um pouco...",
              "Devo botar o volume mais alto...",
              "Será que ponho o som mais forte..."
            ] 
          },
          { 
            english: "Excuse me!", 
            portuguese: "Com licença!", 
            alternativeTranslations: [
              "Licença!",
              "Perdão!",
              "Desculpe!"
            ] 
          }
        ]
      },
      {
        id: 3,
        name: "Nível 3",
        description: "Interações inesperadas",
        estimatedTime: "~1 minuto",
        phrases: [
          { 
            english: "could you turn down your phone's volume?", 
            portuguese: "Você poderia abaixar o volume do seu celular?", 
            alternativeTranslations: [
              "pode baixar o volume do seu celular?",
              "dá pra diminuir o volume do seu telefone?",
              "poderia baixar o som do seu celular?"
            ] 
          },
          { 
            english: "I can hear it from over there!", 
            portuguese: "Eu consigo ouvir daqui!", 
            alternativeTranslations: [
              "Estou ouvindo daqui!",
              "Dá pra ouvir daqui!",
              "Consigo escutar daqui!"
            ] 
          },
          { 
            english: "Ah! The earphones weren't paired!", 
            portuguese: "Ah! Os fones de ouvido não estavam pareados!", 
            alternativeTranslations: [
              "Ah! Os fones não estavam conectados!",
              "Ah! Os fones não tinham sido emparelhados!",
              "Ah! Os fones estavam desconectados!"
            ] 
          },
          { 
            english: "These cheap earphones again...!!", 
            portuguese: "Estes fones de ouvido baratos de novo...!!", 
            alternativeTranslations: [
              "Esses fones baratos outra vez...!!",
              "Esses fones vagabundos de novo...!!",
              "Esses fones econômicos novamente...!!"
            ] 
          },
          { 
            english: "Do you like that song?", 
            portuguese: "Você gosta daquela música?", 
            alternativeTranslations: [
              "Gosta dessa música?",
              "Você curte essa música?",
              "Você gosta dessa canção?"
            ] 
          }
        ]
      }
    ]
  },
  {
    id: 3,
    title: "Chapter 003",
    description: "Conversa sobre Música",
    levels: [
      {
        id: 1,
        name: "Nível 1",
        description: "Gostos musicais em comum",
        estimatedTime: "~1 minuto",
        phrases: [
          { 
            english: "That song from the Long Afternoon", 
            portuguese: "Aquela música da 'Long Afternoon'", 
            alternativeTranslations: [
              "Aquela música do Long Afternoon",
              "Aquela canção da Long Afternoon",
              "Aquela do Long Afternoon"
            ] 
          },
          { 
            english: "I like that song too.", 
            portuguese: "Eu gosto daquela música também.", 
            alternativeTranslations: [
              "Também gosto dessa música.",
              "Curto essa música também.",
              "Gosto dela também."
            ] 
          },
          { 
            english: "I do, I guess", 
            portuguese: "Sim, eu gosto, eu acho.", 
            alternativeTranslations: [
              "Gosto, acho que sim.",
              "Sim, curto, suponho.",
              "Gosto, creio eu."
            ] 
          },
          { 
            english: "He doesn't fit the current trend, he doesn't promote himself or communicate at all.", 
            portuguese: "Ele não se encaixa na tendência atual, ele não se promove ou se comunica de jeito nenhum.", 
            alternativeTranslations: [
              "Ele não segue a moda atual, não se promove nem se comunica de forma alguma.",
              "Não está na moda, não faz promoção nem comunicação nenhuma.",
              "Foge da tendência atual, não se divulga nem interage de maneira alguma."
            ] 
          },
          { 
            english: "If he did a concert, videos would get made and spread everywhere, but he doesn't do anything", 
            portuguese: "Se ele fizesse um show, vídeos seriam feitos e espalhados por toda parte, mas ele não faz nada.", 
            alternativeTranslations: [
              "Se ele se apresentasse, vídeos seriam feitos e viralizariam, mas ele não faz nada.",
              "Cantasse ao vivo, vídeos circulariam por toda internet, mas ele não age.",
              "Se desse um show, haveria vídeos espalhados por todo lado, mas ele não se move."
            ] 
          }
        ]
      },
      {
        id: 2,
        name: "Nível 2",
        description: "Opiniões sobre o artista",
        estimatedTime: "~1 minuto",
        phrases: [
          { 
            english: "He should show his face?", 
            portuguese: "Ele deveria mostrar o rosto dele?", 
            alternativeTranslations: [
              "Deveria revelar o rosto?",
              "Seria bom ele mostrar a cara?",
              "Ele precisava aparecer?"
            ] 
          },
          { 
            english: "I'd like to meet him as a fan, and I'm curious about what he looks like, but", 
            portuguese: "Eu gostaria de encontrá-lo como fã, e estou curioso(a) para saber como ele é, mas", 
            alternativeTranslations: [
              "Queria conhecê-lo como fã, e tenho curiosidade sobre sua aparência, mas",
              "Gostaria de vê-lo pessoalmente, e me pergunto como ele se parece, porém",
              "Adoraria encontrá-lo, e estou curioso sobre seu visual, mas"
            ] 
          },
          { 
            english: "It's also nice to just watch him live the way he wants", 
            portuguese: "Também é bom apenas observá-lo viver do jeito que ele quer.", 
            alternativeTranslations: [
              "Também é legal só ver ele vivendo como prefere.",
              "É bom simplesmente vê-lo seguir seu próprio caminho.",
              "Também é agradável apenas assisti-lo viver como deseja."
            ] 
          },
          { 
            english: "It's good that he focuses on creation and doesn't do anything else, and the mysterious concept is fine too", 
            portuguese: "É bom que ele se concentre na criação e não faça mais nada, e o conceito misterioso também é bom.", 
            alternativeTranslations: [
              "É ótimo ele focar na criação sem outras distrações, e o mistério também funciona.",
              "É positivo ele se dedicar só à música sem outras coisas, e o ar de mistério é legal.",
              "É bom ele focar no trabalho criativo sem dispersar, e o conceito enigmático é bacana."
            ] 
          },
          { 
            english: "I liked the way long afternoon is, just as it is.", 
            portuguese: "Eu gostei do jeito que 'Long Afternoon' é, exatamente como é.", 
            alternativeTranslations: [
              "Gostei da forma como Long Afternoon é, tal qual se apresenta.",
              "Amei o jeito do Long Afternoon, exatamente do modo que está.",
              "Curto o estilo do Long Afternoon, precisamente como se mostra."
            ] 
          }
        ]
      },
      {
        id: 3,
        name: "Nível 3",
        description: "Consciência mútua",
        estimatedTime: "~1 minuto",
        phrases: [
          { 
            english: "We... have run into each other here a few times, right?", 
            portuguese: "Nós... nos encontramos aqui algumas vezes, não é?", 
            alternativeTranslations: [
              "A gente... já se viu aqui algumas vezes, né?",
              "Nós... já nos cruzamos aqui algumas vezes, certo?",
              "Já... nos encontramos aqui algumas vezes, não?"
            ] 
          },
          { 
            english: "Let's just pretend we don't know each other, otherwise she will know I was staring..", 
            portuguese: "Vamos apenas fingir que não nos conhecemos, senão ela saberá que eu estava encarando.", 
            alternativeTranslations: [
              "Melhor fingir que não nos conhecemos, senão ela vai perceber que eu tava encarando.",
              "Vamos fazer de conta que não nos vimos, caso contrário ela descobre que eu tava olhando.",
              "Só finjam que não nos conhecemos, senão ela vai saber que eu tava encarando."
            ] 
          },
          { 
            english: "The train is arriving.", 
            portuguese: "O trem está chegando.", 
            alternativeTranslations: [
              "O trem está vindo.",
              "O trem se aproxima.",
              "Chegou o trem."
            ] 
          },
          { 
            english: "I thought you knew already.", 
            portuguese: "Eu pensei que você já soubesse.", 
            alternativeTranslations: [
              "Achei que você já sabia.",
              "Pensei que você já conhecia.",
              "Imaginei que você já estivesse ciente."
            ] 
          },
          { 
            english: "Since you've always been staring at me.", 
            portuguese: "Já que você sempre esteve me encarando.", 
            alternativeTranslations: [
              "Uma vez que você sempre ficou me olhando.",
              "Porque você sempre esteve me encarando.",
              "Visto que você constantemente me observava."
            ] 
          }
        ]
      }
    ]
  },
  {
    id: 4,
    title: "Chapter 004",
    description: "Preocupações e Decisões",
    levels: [
      {
        id: 1,
        name: "Nível 1",
        description: "Ansiedades sociais",
        estimatedTime: "~1 minuto",
        phrases: [
          { 
            english: "Did some jerk do a rating attack!?", 
            portuguese: "Algum idiota fez um ataque de avaliação!?", 
            alternativeTranslations: [
              "Algum babaca deu um ataque de classificação!?",
              "Algum imbecil fez um ataque de ratings!?",
              "Algum otário disparou um ataque de avaliação!?"
            ] 
          },
          { 
            english: "Boss!! what should I do!?", 
            portuguese: "Chefe! O que eu devo fazer?!", 
            alternativeTranslations: [
              "Chefe!! o que faço?!",
              "Chefe!! o que eu faço?!",
              "Chefe!! qual é a solução?!"
            ] 
          },
          { 
            english: "What if I'm mistaken for a stalker or pervert?", 
            portuguese: "E se eu for confundido com um stalker ou pervertido?", 
            alternativeTranslations: [
              "E se pensarem que sou um perseguidor ou tarado?",
              "E se me tomarem por um stalker ou pervertido?",
              "E se acharem que sou um assediador ou pervertido?"
            ] 
          },
          { 
            english: "What's that about all of a sudden?", 
            portuguese: "O que é isso de repente?", 
            alternativeTranslations: [
              "O que significa isso do nada?",
              "O que é isso assim de supetão?",
              "O que quer dizer isso repentinamente?"
            ] 
          },
          { 
            english: "It just means that girl was also aware of you", 
            portuguese: "Isso apenas significa que aquela garota também estava ciente de você.", 
            alternativeTranslations: [
              "Só quer dizer que aquela moça também te notou.",
              "Significa simplesmente que ela também te percebia.",
              "Quer dizer apenas que ela também estava te observando."
            ] 
          }
        ]
      },
      {
        id: 2,
        name: "Nível 2",
        description: "Raciocínios e preocupações",
        estimatedTime: "~1 minuto",
        phrases: [
          { 
            english: "I'm worried I creeped her out", 
            portuguese: "Estou preocupado(a) de tê-la assustado.", 
            alternativeTranslations: [
              "Receio tê-la deixado desconfortável.",
              "Preocupo ter causado má impressão nela.",
              "Temo tê-la incomodado."
            ] 
          },
          { 
            english: "If she thought I was a pervert, she wouldn't have kept going to the same platform, right?", 
            portuguese: "Se ela pensasse que eu era um pervertido, ela não continuaria indo para a mesma plataforma, certo?", 
            alternativeTranslations: [
              "Se ela me achasse um tarado, não voltaria à mesma plataforma, né?",
              "Caso me considerasse pervertido, não manteria o mesmo local, certo?",
              "Se pensasse que sou pervertido, não frequentaria o mesmo lugar, não é?"
            ] 
          },
          { 
            english: "She'd have avoided it a long time ago.", 
            portuguese: "Ela teria evitado isso há muito tempo.", 
            alternativeTranslations: [
              "Ela já teria fugido disso faz tempo.",
              "Já teria se afastado há muito.",
              "Teria se esquivado disso já faz tempo."
            ] 
          },
          { 
            english: "If you're worried, you should talk to her properly next time", 
            portuguese: "Se você está preocupado, você deveria falar com ela direito da próxima vez.", 
            alternativeTranslations: [
              "Se está inseguro, deveria conversar adequadamente com ela na próxima.",
              "Caso esteja apreensivo, fale direito com ela na próxima oportunidade.",
              "Se tem receio, deve abordá-la adequadamente da próxima vez."
            ] 
          },
          { 
            english: "Why? you're also aware of her aren't you?", 
            portuguese: "Por quê? Você também está ciente dela, não está?", 
            alternativeTranslations: [
              "Por quê? Você também nota ela, não é?",
              "Por quê? Você também repara nela, né?",
              "Por quê? Você também está atento a ela, não está?"
            ] 
          }
        ]
      },
      {
        id: 3,
        name: "Nível 3",
        description: "Estratégias e decisões",
        estimatedTime: "~1 minuto",
        phrases: [
          { 
            english: "Why does she go home late?", 
            portuguese: "Por que ela volta para casa tarde?", 
            alternativeTranslations: [
              "Por que ela chega em casa tarde?",
              "Por que ela vai pra casa tarde?",
              "Por que ela retorna tarde pra casa?"
            ] 
          },
          { 
            english: "What does she do?", 
            portuguese: "O que ela faz?", 
            alternativeTranslations: [
              "Qual é a profissão dela?",
              "O que ela trabalha?",
              "Qual o trabalho dela?"
            ] 
          },
          { 
            english: "isn't that how it starts usually?", 
            portuguese: "Não é assim que geralmente começa?", 
            alternativeTranslations: [
              "Não costuma ser assim que começa?",
              "Não é normalmente assim que inicia?",
              "Não é desse jeito que geralmente surge?"
            ] 
          },
          { 
            english: "As I said, that's how relationships usually start", 
            portuguese: "Como eu disse, é assim que os relacionamentos geralmente começam.", 
            alternativeTranslations: [
              "Como falei, é desse jeito que os relacionamentos costumam surgir.",
              "Como disse, é assim que normalmente começam os relacionamentos.",
              "Como eu disse, é dessa forma que as relações geralmente se iniciam."
            ] 
          },
          { 
            english: "Gotta clear things up so she doesn't think I'm a creep", 
            portuguese: "Tenho que esclarecer as coisas para que ela não pense que eu sou um esquisito/assustador.", 
            alternativeTranslations: [
              "Preciso esclarecer a situação pra ela não me achar estranho.",
              "Tenho que me explicar pra ela não pensar que sou creepy.",
              "Devo me justificar pra ela não me considerar assustador."
            ] 
          }
        ]
      }
    ]
  }
];

    // Estado do aplicativo
    let currentState = {
      currentChapter: null,
      currentLevel: null,
      currentMode: null,
      currentQuestions: [],
      wrongAnswers: [],
      currentQuestionIndex: 0,
      correctCount: 0,
      wrongCount: 0,
      isReviewMode: false,
      currentAttempt: 1,
      currentQuestionAnalysis: null
    };

    // Elementos DOM
    const elements = {
      // Telas
      mainMenu: document.getElementById('main-menu'),
      chaptersMenu: document.getElementById('chapters-menu'),
      levelMenu: document.getElementById('level-menu'),
      practiceModeMenu: document.getElementById('practice-mode-menu'),
      quizScreen: document.getElementById('quiz-screen'),
      resultsScreen: document.getElementById('results-screen'),
      // Botões de navegação
      storyModeBtn: document.getElementById('story-mode-btn'),
      backToMain: document.getElementById('back-to-main'),
      backToChapters: document.getElementById('back-to-chapters'),
      backToLevels: document.getElementById('back-to-levels'),
      backToPractice: document.getElementById('back-to-practice'),
      backToChaptersFromResults: document.getElementById('back-to-chapters-from-results'),
      // Elementos do quiz
      chapterLevelTitle: document.getElementById('chapter-level-title'),
      chapterPracticeTitle: document.getElementById('chapter-practice-title'),
      quizTitle: document.getElementById('quiz-title'),
      quizSubtitle: document.getElementById('quiz-subtitle'),
      questionNumber: document.getElementById('question-number'),
      questionStats: document.getElementById('question-stats'),
      progressBar: document.getElementById('progress-bar'),
      questionText: document.getElementById('question-text'),
      answerInput: document.getElementById('answer-input'),
      submitAnswer: document.getElementById('submit-answer'),
      skipButton: document.getElementById('skip-button'),
      // Elementos de feedback
      feedbackArea: document.getElementById('feedback-area'),
      feedbackIcon: document.getElementById('feedback-icon'),
      feedbackTitle: document.getElementById('feedback-title-text'),
      correctAnswer: document.getElementById('correct-answer'),
      vocabTable: document.getElementById('vocab-table'),
      nextQuestion: document.getElementById('next-question'),
      wordFeedbackArea: document.getElementById('word-feedback-area'),
      wordFeedbackContent: document.getElementById('word-feedback-content'),
      retryContainer: document.getElementById('retry-container'),
      retryButton: document.getElementById('retry-button'),
      // Elementos de resultados
      resultsSubtitle: document.getElementById('results-subtitle'),
      scoreCircle: document.getElementById('score-circle'),
      scoreValue: document.getElementById('score-value'),
      completionMessage: document.getElementById('completion-message'),
      correctAnswers: document.getElementById('correct-answers'),
      wrongAnswers: document.getElementById('wrong-answers'),
      completionRate: document.getElementById('completion-rate'),
      restartPractice: document.getElementById('restart-practice'),
      // Grids
      chaptersGrid: document.getElementById('chapters-grid'),
      levelsGrid: document.getElementById('levels-grid'),
      // Botões de modo de prática
      easyPracticeBtn: document.getElementById('easy-practice-btn'),
      hardPracticeBtn: document.getElementById('hard-practice-btn')
    };

    // Inicialização
    function init() {
      // Garante que apenas o menu principal está visível no início
      hideAllScreens();
      elements.mainMenu.classList.remove('hidden');
      
      renderChaptersGrid();
      attachEventListeners();
    }

    // Anexar event listeners
    function attachEventListeners() {
      elements.storyModeBtn.addEventListener('click', showChaptersMenu);
      elements.backToMain.addEventListener('click', showMainMenu);
      elements.backToChapters.addEventListener('click', showChaptersMenu);
      elements.backToLevels.addEventListener('click', () => {
        if (currentState.currentChapter) {
          showLevelMenu(currentState.currentChapter);
        }
      });
      elements.backToPractice.addEventListener('click', () => {
        if (currentState.currentLevel) {
          showPracticeModeMenu(currentState.currentLevel);
        }
      });
      elements.backToChaptersFromResults.addEventListener('click', showChaptersMenu);
      elements.easyPracticeBtn.addEventListener('click', () => startPractice('easy'));
      elements.hardPracticeBtn.addEventListener('click', () => startPractice('hard'));
      elements.submitAnswer.addEventListener('click', checkAnswer);
      elements.skipButton.addEventListener('click', skipQuestion);
      elements.nextQuestion.addEventListener('click', nextQuestion);
      elements.retryButton.addEventListener('click', enableRetry);
      elements.answerInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          if (elements.feedbackArea.classList.contains('hidden')) {
            checkAnswer();
          } else if (!elements.retryContainer.classList.contains('hidden')) {
            enableRetry();
          } else {
            nextQuestion();
          }
        }
      });
      elements.restartPractice.addEventListener('click', () => {
        startPractice(currentState.currentMode);
      });
    }

    // Funções de navegação
    function showMainMenu() {
      hideAllScreens();
      elements.mainMenu.classList.remove('hidden');
    }

    function showChaptersMenu() {
      hideAllScreens();
      elements.chaptersMenu.classList.remove('hidden');
    }

    // Renderizar capítulos
    function renderChaptersGrid() {
      elements.chaptersGrid.innerHTML = CHAPTERS.map(chapter => `
        <div class="chapter-card" data-chapter-id="${chapter.id}">
          <div class="chapter-number">Capítulo ${chapter.id.toString().padStart(3, '0')}</div>
          <div class="chapter-title">${chapter.title}</div>
          <div class="chapter-stats">
            <span>3 níveis</span>
            <span><i class="fas fa-star"></i> ${chapter.id}.0</span>
          </div>
        </div>
      `).join('');

      document.querySelectorAll('.chapter-card').forEach(card => {
        card.addEventListener('click', () => {
          const chapterId = parseInt(card.getAttribute('data-chapter-id'));
          const chapter = CHAPTERS.find(c => c.id === chapterId);
          if (chapter) {
            showLevelMenu(chapter);
          }
        });
      });
    }

    // Mostrar menu de níveis
    function showLevelMenu(chapter) {
      hideAllScreens();
      currentState.currentChapter = chapter;
      elements.chapterLevelTitle.textContent = `Capítulo ${chapter.id.toString().padStart(3, '0')} - ${chapter.title}`;
      elements.levelsGrid.innerHTML = chapter.levels.map(level => `
        <div class="chapter-card" data-level-id="${level.id}">
          <div class="chapter-number">${level.name}</div>
          <div class="chapter-title">${level.description}</div>
          <div class="chapter-stats">
            <span>5 frases</span>
            <span>${level.estimatedTime}</span>
          </div>
        </div>
      `).join('');

      document.querySelectorAll('.chapter-card').forEach(card => {
        card.addEventListener('click', () => {
          const levelId = parseInt(card.getAttribute('data-level-id'));
          const level = chapter.levels.find(l => l.id === levelId);
          if (level) {
            showPracticeModeMenu(level);
          }
        });
      });

      elements.levelMenu.classList.remove('hidden');
    }

    // Mostrar menu de modo de prática
    function showPracticeModeMenu(level) {
      hideAllScreens();
      currentState.currentLevel = level;
      elements.chapterPracticeTitle.textContent = `${level.name} - ${level.description}`;
      elements.practiceModeMenu.classList.remove('hidden');
    }

    // Iniciar prática
    function startPractice(mode) {
      currentState.currentMode = mode;
      currentState.currentQuestions = [...currentState.currentLevel.phrases];
      currentState.wrongAnswers = [];
      currentState.currentQuestionIndex = 0;
      currentState.correctCount = 0;
      currentState.wrongCount = 0;
      currentState.isReviewMode = false;
      currentState.currentAttempt = 1;
      showQuizScreen();
      loadQuestion();
    }

    // Mostrar tela de quiz
    function showQuizScreen() {
      hideAllScreens();
      elements.quizScreen.classList.remove('hidden');
      const modeName = currentState.currentMode === 'easy' ? 'Fácil' : 'Difícil';
      elements.quizTitle.textContent = `Prática ${modeName}`;
      elements.quizSubtitle.textContent = currentState.currentMode === 'easy'
        ? 'Traduza do Inglês para Português'
        : 'Traduza do Português para Inglês';
    }

    // Carregar questão
    function loadQuestion() {
      const question = currentState.currentQuestions[currentState.currentQuestionIndex];
      const totalQuestions = currentState.currentQuestions.length;
      elements.questionNumber.textContent = `Questão ${currentState.currentQuestionIndex + 1} de ${totalQuestions}`;
      elements.questionStats.textContent = `Acertos: ${currentState.correctCount} | Erros: ${currentState.wrongCount}`;
      const progress = (currentState.currentQuestionIndex / totalQuestions) * 100;
      elements.progressBar.style.width = `${progress}%`;
      elements.questionText.textContent = currentState.currentMode === 'easy'
        ? question.english
        : question.portuguese;
      elements.answerInput.value = '';
      elements.feedbackArea.classList.add('hidden');
      elements.wordFeedbackArea.classList.add('hidden');
      elements.retryContainer.classList.add('hidden');
      elements.answerInput.focus();
      currentState.currentAttempt = 1;
    }

    // Pular questão
    function skipQuestion() {
      currentState.wrongCount++;
      currentState.currentQuestionIndex++;
      if (currentState.currentQuestionIndex < currentState.currentQuestions.length) {
        loadQuestion();
      } else {
        showResults();
      }
    }

    // Verificar resposta
    function checkAnswer() {
      const userAnswer = elements.answerInput.value.trim();
      if (!userAnswer) return;
      const question = currentState.currentQuestions[currentState.currentQuestionIndex];
      const correctAnswers = [question.portuguese, ...question.alternativeTranslations];
      const isEasyMode = currentState.currentMode === 'easy';
      const analysis = analyzeAnswer(userAnswer, correctAnswers, isEasyMode);
      const isCorrect = analysis.isCorrect;
      showFeedback(isCorrect, correctAnswers[0], question, analysis);
      if (isCorrect || currentState.currentAttempt === 2) {
        if (isCorrect) {
          currentState.correctCount++;
        } else {
          currentState.wrongCount++;
          if (!currentState.isReviewMode) {
            currentState.wrongAnswers.push(question);
          }
        }
        elements.questionStats.textContent = `Acertos: ${currentState.correctCount} | Erros: ${currentState.wrongCount}`;
      }
    }

    // Funções de análise
    function analyzeAnswer(userAnswer, correctAnswers, isEasyMode) {
      const normalizedUser = normalizeText(userAnswer);
      const normalizedCorrects = correctAnswers.map(ca => normalizeText(ca));
      for (const correct of normalizedCorrects) {
        if (normalizedUser === correct) {
          return { isCorrect: true, wordAnalysis: [] };
        }
      }
      const userWords = normalizedUser.split(/\s+/).filter(w => w);
      const correctWords = normalizedCorrects[0].split(/\s+/).filter(w => w);
      const wordAnalysis = [];
      const used = new Set();
      userWords.forEach(uw => {
        let best = null;
        correctWords.forEach((cw, i) => {
          if (!used.has(i)) {
            const sim = calculateSimilarity(uw, cw);
            if (sim > 0.6 && (!best || sim > best.similarity)) {
              best = { word: cw, index: i, similarity: sim };
            }
          }
        });
        if (best) {
          used.add(best.index);
          wordAnalysis.push({ userWord: uw, correctWord: best.word, status: uw === best.word ? 'correct' : 'wrong-position', position: best.index });
        } else {
          wordAnalysis.push({ userWord: uw, correctWord: null, status: 'incorrect', position: -1 });
        }
      });
      correctWords.forEach((cw, i) => {
        if (!used.has(i)) {
          wordAnalysis.push({ userWord: null, correctWord: cw, status: 'missing', position: i });
        }
      });
      wordAnalysis.sort((a, b) => a.position - b.position);
      return { isCorrect: false, wordAnalysis };
    }

    function normalizeText(text) {
      return text.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[.,?!;:'"()]/g, '')
        .replace(/\s+/g, ' ').trim();
    }

    function calculateSimilarity(w1, w2) {
      if (w1 === w2) return 1;
      if (w1.includes(w2) || w2.includes(w1)) return 0.8;
      const max = Math.max(w1.length, w2.length);
      let diff = 0;
      for (let i = 0; i < max; i++) {
        if (w1[i] !== w2[i]) diff++;
      }
      const sim = 1 - (diff / max);
      return sim > 0.7 ? sim : 0;
    }

    // Feedback
    function showFeedback(isCorrect, correctAnswer, question, analysis) {
      if (isCorrect) {
        elements.feedbackIcon.className = 'fas fa-check-circle';
        elements.feedbackTitle.textContent = 'Resposta Correta!';
        elements.feedbackIcon.style.color = 'var(--success)';
        elements.retryContainer.classList.add('hidden');
      } else {
        elements.feedbackIcon.className = 'fas fa-times-circle';
        elements.feedbackTitle.textContent = currentState.currentAttempt === 1 ? 'Quase lá! Veja o feedback:' : 'Resposta Incorreta';
        elements.feedbackIcon.style.color = 'var(--error)';
        if (currentState.currentAttempt === 1 && analysis.wordAnalysis.length > 0) {
          showWordAnalysis(analysis.wordAnalysis);
          elements.retryContainer.classList.remove('hidden');
        } else {
          elements.wordFeedbackArea.classList.add('hidden');
          elements.retryContainer.classList.add('hidden');
        }
      }
      elements.correctAnswer.textContent = correctAnswer;
      generateVocabTable(question);
      elements.feedbackArea.classList.remove('hidden');
      if (!isCorrect) currentState.currentQuestionAnalysis = analysis;
    }

    function showWordAnalysis(wordAnalysis) {
      elements.wordFeedbackContent.innerHTML = '';
      wordAnalysis.forEach(item => {
        const bubble = document.createElement('div');
        bubble.className = `word-bubble word-${item.status}`;
        if (item.status === 'correct') {
          bubble.textContent = item.userWord;
          bubble.title = 'Palavra correta na posição certa';
        } else if (item.status === 'wrong-position') {
          bubble.textContent = item.userWord;
          bubble.title = `Palavra existe mas deveria estar em outra posição. Correta: "${item.correctWord}"`;
        } else if (item.status === 'incorrect') {
          bubble.textContent = item.userWord;
          bubble.title = 'Palavra não existe na tradução correta';
        } else if (item.status === 'missing') {
          bubble.textContent = item.correctWord;
          bubble.title = 'Palavra faltando na sua resposta';
        }
        elements.wordFeedbackContent.appendChild(bubble);
      });
      elements.wordFeedbackArea.classList.remove('hidden');
    }

    function enableRetry() {
      currentState.currentAttempt = 2;
      elements.feedbackArea.classList.add('hidden');
      elements.answerInput.value = '';
      elements.answerInput.focus();
    }

    function generateVocabTable(question) {
      const enWords = question.english.split(' ').slice(0, 10);
      const ptWords = question.portuguese.split(' ').slice(0, 10);
      let html = '';
      const max = Math.max(enWords.length, ptWords.length);
      for (let i = 0; i < max; i++) {
        const en = enWords[i] || '';
        const pt = ptWords[i] || '';
        if (en.trim() || pt.trim()) {
          html += `<tr><td><strong>${en}</strong></td><td>${pt}</td></tr>`;
        }
      }
      elements.vocabTable.innerHTML = html || `<tr><td colspan="2" class="text-center">Não foi possível gerar o vocabulário.</td></tr>`;
    }

    // Próxima questão
    function nextQuestion() {
      currentState.currentQuestionIndex++;
      if (currentState.currentQuestionIndex < currentState.currentQuestions.length) {
        loadQuestion();
      } else {
        if (!currentState.isReviewMode && currentState.wrongAnswers.length > 0) {
          currentState.isReviewMode = true;
          currentState.currentQuestions = [...currentState.wrongAnswers];
          currentState.currentQuestionIndex = 0;
          currentState.wrongAnswers = [];
          loadQuestion();
        } else {
          showResults();
        }
      }
    }

    // Resultados
    function showResults() {
      hideAllScreens();
      elements.resultsScreen.classList.remove('hidden');
      const total = currentState.currentLevel.phrases.length;
      const totalAttempts = currentState.correctCount + currentState.wrongCount;
      const correctPerc = totalAttempts ? Math.round((currentState.correctCount / totalAttempts) * 100) : 0;
      const completionPerc = Math.round((currentState.correctCount / total) * 100);
      elements.scoreCircle.style.background = `conic-gradient(var(--primary) ${correctPerc}%, var(--dark) 0%)`;
      elements.scoreValue.textContent = `${correctPerc}%`;
      if (completionPerc === 100) {
        elements.completionMessage.textContent = 'Parabéns! Domínio Total! 🎉';
        elements.completionMessage.style.color = 'var(--success)';
      } else if (completionPerc >= 80) {
        elements.completionMessage.textContent = 'Excelente! Quase Perfeito! 👏';
        elements.completionMessage.style.color = 'var(--success)';
      } else if (completionPerc >= 60) {
        elements.completionMessage.textContent = 'Bom Trabalho! Continue Assim! 💪';
        elements.completionMessage.style.color = 'var(--warning)';
      } else {
        elements.completionMessage.textContent = 'Continue Praticando! Você Consegue! 📚';
        elements.completionMessage.style.color = 'var(--error)';
      }
      elements.correctAnswers.textContent = currentState.correctCount;
      elements.wrongAnswers.textContent = currentState.wrongCount;
      elements.completionRate.textContent = `${completionPerc}%`;
      elements.resultsSubtitle.textContent = `Capítulo ${currentState.currentChapter.id.toString().padStart(3, '0')} - ${currentState.currentLevel.name}`;
    }

    // Esconder todas as telas
    function hideAllScreens() {
      elements.mainMenu.classList.add('hidden');
      elements.chaptersMenu.classList.add('hidden');
      elements.levelMenu.classList.add('hidden');
      elements.practiceModeMenu.classList.add('hidden');
      elements.quizScreen.classList.add('hidden');
      elements.resultsScreen.classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>